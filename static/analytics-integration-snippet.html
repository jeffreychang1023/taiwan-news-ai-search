<!--
    Analytics Integration Snippet for news-search-prototype.html

    Add this snippet just before the closing </body> tag in news-search-prototype.html
    This will enable analytics tracking for ML training data collection.
-->

<script src="/static/analytics-tracker-sse.js"></script>
<script>
    // Initialize analytics tracker
    const analyticsTracker = new AnalyticsTrackerSSE('/api/analytics/event');

    // Keep track of current query ID
    let currentAnalyticsQueryId = null;

    // ==========================================
    // INTEGRATION HOOK 1: Track query start
    // ==========================================
    // Add this to the performSearch() function, right after query validation
    //
    // FIND THIS CODE (around line 1648):
    //     async function performSearch() {
    //         const query = searchInput.value.trim();
    //         if (!query) return;
    //
    // ADD AFTER IT:
    //     // Analytics: Start tracking query
    //     currentAnalyticsQueryId = `query_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
    //     analyticsTracker.startQuery(currentAnalyticsQueryId, query);
    //

    // ==========================================
    // INTEGRATION HOOK 2: Track results displayed
    // ==========================================
    // Add this function to track article rendering

    function trackArticleDisplayed(articleElement, article, position) {
        if (!currentAnalyticsQueryId || !article) return;

        const url = article.url || article.schema_object?.url || '';
        if (!url) return;

        // Add data attributes for analytics
        articleElement.dataset.analyticsUrl = url;
        articleElement.dataset.analyticsPosition = position;

        // Track that this result was displayed
        analyticsTracker.trackResultDisplayed(url, position, {
            title: article.name || article.title || '',
            has_image: !!(article.image || article.schema_object?.image)
        });

        // Set up click tracking on all links within this article
        const links = articleElement.querySelectorAll('a[href]');
        links.forEach(link => {
            link.addEventListener('click', (event) => {
                analyticsTracker.trackClick(url, position, event);
            });
        });

        // Observe for visibility tracking
        analyticsTracker.observeResult(articleElement);
    }

    // ==========================================
    // INTEGRATION HOOK 3: Modify article rendering
    // ==========================================
    // In the populateResultsFromAPI() function, after creating each article card,
    // call trackArticleDisplayed()
    //
    // FIND THIS CODE (around line 1600-1650 where articles are rendered):
    //     articles.forEach((article, index) => {
    //         const articleCard = document.createElement('div');
    //         articleCard.className = 'article-card';
    //         // ... (article rendering code)
    //         listView.appendChild(articleCard);
    //     });
    //
    // MODIFY TO:
    //     articles.forEach((article, index) => {
    //         const articleCard = document.createElement('div');
    //         articleCard.className = 'article-card';
    //         // ... (article rendering code)
    //         listView.appendChild(articleCard);
    //
    //         // ADD THIS LINE:
    //         trackArticleDisplayed(articleCard, article, index);
    //     });

    // ==========================================
    // INTEGRATION HOOK 4: Chat mode tracking
    // ==========================================
    // For chat mode (free conversation), track query starts
    //
    // FIND THIS CODE in performFreeConversation() (around line 1770):
    //     async function performFreeConversation(query) {
    //         // Add user message to chat
    //         addChatMessage('user', query);
    //
    // ADD AFTER IT:
    //     // Analytics: Track chat query
    //     currentAnalyticsQueryId = `chat_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
    //     analyticsTracker.startQuery(currentAnalyticsQueryId, query);

    console.log('[Analytics] Integration script loaded. Tracker initialized.');
</script>

<!--
    MANUAL INTEGRATION STEPS:

    1. Add the <script> tags above just before </body> in news-search-prototype.html

    2. In performSearch() function (line ~1650), add after "if (!query) return;":
       ```javascript
       // Analytics: Start tracking query
       currentAnalyticsQueryId = `query_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
       analyticsTracker.startQuery(currentAnalyticsQueryId, query);
       ```

    3. In populateResultsFromAPI() function (line ~1600-1650), after creating each article card:
       ```javascript
       listView.appendChild(articleCard);

       // ADD THIS:
       trackArticleDisplayed(articleCard, article, index);
       ```

    4. In performFreeConversation() function (line ~1770), add after "addChatMessage('user', query);":
       ```javascript
       // Analytics: Track chat query
       currentAnalyticsQueryId = `chat_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
       analyticsTracker.startQuery(currentAnalyticsQueryId, query);
       ```

    5. Test by:
       - Opening browser console
       - Performing a search
       - Checking for "[Analytics-SSE]" log messages
       - Clicking on a result link
       - Checking backend logs for analytics events
-->
