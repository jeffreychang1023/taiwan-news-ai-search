# P4.2: Externalize Writer Templates - Detailed Implementation

**Estimated Effort**: 0.5 day
**Impact**: Low - Enables i18n and template management
**ROI**: ⭐⭐

---

## Problem Statement

Writer templates are hardcoded in Python methods:
- Difficult to update without code changes
- No i18n support
- Templates mixed with logic

---

## Solution

Move templates to YAML configuration files with language support.

---

## Implementation

### Step 1: Create Template Configuration

#### File: `config/writer_templates.yaml`

```yaml
# Writer output templates by mode and language

templates:
  strict:
    zh-TW:
      title: "事實查核報告"
      structure: |
        ## 查核結果

        {verdict}

        ## 詳細分析

        {analysis}

        ## 證據來源

        {citations}

        ### 來源品質評估

        {source_quality}

        ## 查核信心度

        **整體信心**: {confidence}%

        {confidence_explanation}

        ---
        *本報告由 Deep Research 系統自動產生*

      verdict_templates:
        verified: "✅ **已查證屬實** - 有充分證據支持此聲明"
        false: "❌ **查證為偽** - 證據顯示此聲明不正確"
        partially_true: "⚠️ **部分屬實** - 聲明包含正確和不正確的部分"
        unverifiable: "❓ **無法查證** - 現有證據不足以確認或否認"
        misleading: "⚡ **具誤導性** - 聲明雖有事實基礎，但呈現方式可能造成誤解"

    en-US:
      title: "Fact Check Report"
      structure: |
        ## Verification Result

        {verdict}

        ## Detailed Analysis

        {analysis}

        ## Evidence Sources

        {citations}

        ### Source Quality Assessment

        {source_quality}

        ## Confidence Level

        **Overall Confidence**: {confidence}%

        {confidence_explanation}

        ---
        *This report was automatically generated by Deep Research*

      verdict_templates:
        verified: "✅ **Verified** - Sufficient evidence supports this claim"
        false: "❌ **False** - Evidence shows this claim is incorrect"
        partially_true: "⚠️ **Partially True** - Claim contains both accurate and inaccurate parts"
        unverifiable: "❓ **Unverifiable** - Insufficient evidence to confirm or deny"
        misleading: "⚡ **Misleading** - Claim has factual basis but may be presented misleadingly"

  discovery:
    zh-TW:
      title: "研究報告"
      structure: |
        ## 研究發現

        {summary}

        ## 主要分析

        {analysis}

        ## 關鍵洞察

        {insights}

        ## 不同觀點

        {perspectives}

        ## 參考來源

        {citations}

        ---
        *本報告由 Deep Research 系統自動產生*

    en-US:
      title: "Research Report"
      structure: |
        ## Key Findings

        {summary}

        ## Main Analysis

        {analysis}

        ## Key Insights

        {insights}

        ## Different Perspectives

        {perspectives}

        ## References

        {citations}

        ---
        *This report was automatically generated by Deep Research*

  monitor:
    zh-TW:
      title: "趨勢監測報告"
      structure: |
        ## 趨勢概覽

        {summary}

        ## 時間軸分析

        {timeline}

        ## 關鍵轉折點

        {turning_points}

        ## 趨勢方向

        {trend_direction}

        ## 資料來源

        {citations}

        ---
        *本報告由 Deep Research 系統自動產生*

    en-US:
      title: "Trend Monitoring Report"
      structure: |
        ## Trend Overview

        {summary}

        ## Timeline Analysis

        {timeline}

        ## Key Turning Points

        {turning_points}

        ## Trend Direction

        {trend_direction}

        ## Data Sources

        {citations}

        ---
        *This report was automatically generated by Deep Research*

# Default language
default_language: zh-TW

# Citation format templates
citation_formats:
  inline: "[{id}]"
  reference: "[{id}] {title} - {source} ({date})"
  reference_with_url: "[{id}] [{title}]({url}) - {source} ({date})"

# Confidence level descriptions
confidence_levels:
  zh-TW:
    high: "高度信心 (85%+) - 多個高品質來源一致支持"
    medium: "中度信心 (60-84%) - 有支持證據但可能有限"
    low: "低度信心 (<60%) - 證據不足或來源品質較低"
  en-US:
    high: "High Confidence (85%+) - Multiple high-quality sources consistently support"
    medium: "Medium Confidence (60-84%) - Supporting evidence exists but may be limited"
    low: "Low Confidence (<60%) - Insufficient evidence or lower quality sources"
```

---

### Step 2: Create Template Loader

#### File: `code/python/reasoning/templates/loader.py`

```python
"""Template loader for writer output formatting."""

import yaml
from pathlib import Path
from typing import Dict, Any, Optional
from functools import lru_cache
import logging

logger = logging.getLogger(__name__)


class TemplateLoader:
    """
    Loader for writer output templates.

    Supports multiple languages and research modes.
    """

    def __init__(self, config_path: Optional[Path] = None):
        """
        Initialize template loader.

        Args:
            config_path: Path to templates YAML file.
                         Defaults to config/writer_templates.yaml
        """
        if config_path is None:
            code_dir = Path(__file__).parent.parent.parent.parent
            config_path = code_dir / "config" / "writer_templates.yaml"

        self.config_path = config_path
        self._templates: Optional[Dict[str, Any]] = None

    @property
    def templates(self) -> Dict[str, Any]:
        """Lazy load templates."""
        if self._templates is None:
            self._load_templates()
        return self._templates

    def _load_templates(self) -> None:
        """Load templates from YAML file."""
        if not self.config_path.exists():
            logger.warning(f"Template config not found: {self.config_path}")
            self._templates = {}
            return

        with open(self.config_path, 'r', encoding='utf-8') as f:
            self._templates = yaml.safe_load(f) or {}

        logger.debug(f"Loaded templates from {self.config_path}")

    def reload(self) -> None:
        """Reload templates from file."""
        self._templates = None
        self._load_templates()

    def get_template(
        self,
        mode: str,
        lang: Optional[str] = None,
    ) -> Dict[str, Any]:
        """
        Get template for mode and language.

        Args:
            mode: Research mode (strict, discovery, monitor)
            lang: Language code (zh-TW, en-US). Uses default if not specified.

        Returns:
            Template dictionary with structure and components
        """
        if lang is None:
            lang = self.templates.get("default_language", "zh-TW")

        mode_templates = self.templates.get("templates", {}).get(mode, {})

        # Try requested language
        if lang in mode_templates:
            return mode_templates[lang]

        # Fall back to default language
        default_lang = self.templates.get("default_language", "zh-TW")
        if default_lang in mode_templates:
            logger.warning(f"Language '{lang}' not found, using '{default_lang}'")
            return mode_templates[default_lang]

        # Fall back to discovery mode
        logger.warning(f"Mode '{mode}' not found, using 'discovery'")
        return self.templates.get("templates", {}).get("discovery", {}).get(
            default_lang, {}
        )

    def get_structure(
        self,
        mode: str,
        lang: Optional[str] = None,
    ) -> str:
        """Get the main structure template."""
        template = self.get_template(mode, lang)
        return template.get("structure", "")

    def get_verdict_template(
        self,
        mode: str,
        verdict_type: str,
        lang: Optional[str] = None,
    ) -> str:
        """
        Get verdict template for strict mode.

        Args:
            mode: Research mode
            verdict_type: Type of verdict (verified, false, etc.)
            lang: Language code

        Returns:
            Verdict text template
        """
        template = self.get_template(mode, lang)
        verdicts = template.get("verdict_templates", {})
        return verdicts.get(verdict_type, f"[{verdict_type}]")

    def get_confidence_description(
        self,
        confidence: float,
        lang: Optional[str] = None,
    ) -> str:
        """
        Get confidence level description.

        Args:
            confidence: Confidence score (0.0-1.0)
            lang: Language code

        Returns:
            Description text for confidence level
        """
        if lang is None:
            lang = self.templates.get("default_language", "zh-TW")

        levels = self.templates.get("confidence_levels", {}).get(lang, {})

        if confidence >= 0.85:
            return levels.get("high", "High confidence")
        elif confidence >= 0.60:
            return levels.get("medium", "Medium confidence")
        else:
            return levels.get("low", "Low confidence")

    def format_citation(
        self,
        citation_id: int,
        title: str = "",
        source: str = "",
        date: str = "",
        url: str = "",
        format_type: str = "reference",
    ) -> str:
        """
        Format a citation according to template.

        Args:
            citation_id: Citation number
            title: Source title
            source: Source name
            date: Publication date
            url: Source URL
            format_type: Format type (inline, reference, reference_with_url)

        Returns:
            Formatted citation string
        """
        formats = self.templates.get("citation_formats", {})
        template = formats.get(format_type, "[{id}]")

        return template.format(
            id=citation_id,
            title=title,
            source=source,
            date=date,
            url=url,
        )


# Global instance
template_loader = TemplateLoader()


def get_template(mode: str, lang: Optional[str] = None) -> Dict[str, Any]:
    """Convenience function to get template."""
    return template_loader.get_template(mode, lang)


def get_structure(mode: str, lang: Optional[str] = None) -> str:
    """Convenience function to get structure template."""
    return template_loader.get_structure(mode, lang)
```

---

### Step 3: Update Writer Agent

#### File: `code/python/reasoning/agents/writer.py`

```python
# Add import
from reasoning.templates.loader import template_loader, get_structure


class WriterAgent:
    """Writer agent for composing final reports."""

    def __init__(self, config: Dict[str, Any], logger: logging.Logger):
        self.config = config
        self.logger = logger
        self.lang = config.get("language", "zh-TW")

    async def compose(
        self,
        draft: str,
        review: Optional[str],
        query: str,
        mode: str,
        sources: List[Dict[str, Any]],
    ) -> str:
        """
        Compose final report from draft and review.

        Args:
            draft: Analyst draft
            review: Critic review
            query: Original query
            mode: Research mode
            sources: Source items used

        Returns:
            Final formatted report
        """
        # Parse draft data
        draft_data = self._parse_draft(draft)

        # Get template
        template = get_structure(mode, self.lang)

        # Format components
        components = self._prepare_components(draft_data, sources, mode)

        # Render template
        report = self._render_template(template, components)

        return report

    def _prepare_components(
        self,
        draft_data: Dict[str, Any],
        sources: List[Dict[str, Any]],
        mode: str,
    ) -> Dict[str, str]:
        """Prepare template components from draft data."""
        components = {
            "summary": draft_data.get("summary", ""),
            "analysis": draft_data.get("analysis", ""),
            "insights": self._format_insights(draft_data.get("insights", [])),
            "citations": self._format_citations(
                draft_data.get("citations_used", []),
                sources
            ),
            "confidence": int(draft_data.get("confidence_score", 0.5) * 100),
            "confidence_explanation": template_loader.get_confidence_description(
                draft_data.get("confidence_score", 0.5),
                self.lang
            ),
        }

        # Mode-specific components
        if mode == "strict":
            verdict_type = self._determine_verdict(draft_data)
            components["verdict"] = template_loader.get_verdict_template(
                mode, verdict_type, self.lang
            )
            components["source_quality"] = self._format_source_quality(sources)

        elif mode == "discovery":
            components["perspectives"] = self._format_perspectives(
                draft_data.get("perspectives", [])
            )

        elif mode == "monitor":
            components["timeline"] = self._format_timeline(
                draft_data.get("timeline", [])
            )
            components["turning_points"] = self._format_turning_points(
                draft_data.get("turning_points", [])
            )
            components["trend_direction"] = draft_data.get("trend_direction", "")

        return components

    def _render_template(
        self,
        template: str,
        components: Dict[str, str],
    ) -> str:
        """Render template with components."""
        try:
            return template.format(**components)
        except KeyError as e:
            self.logger.warning(f"Missing template component: {e}")
            # Fill missing with placeholder
            for key in self._extract_placeholders(template):
                if key not in components:
                    components[key] = f"[{key}]"
            return template.format(**components)

    def _extract_placeholders(self, template: str) -> List[str]:
        """Extract placeholder names from template."""
        import re
        return re.findall(r'\{(\w+)\}', template)

    def _format_citations(
        self,
        citation_ids: List[int],
        sources: List[Dict[str, Any]],
    ) -> str:
        """Format citations section."""
        if not citation_ids:
            return "*無引用來源*"

        lines = []
        for cid in citation_ids:
            if 0 < cid <= len(sources):
                source = sources[cid - 1]
                formatted = template_loader.format_citation(
                    citation_id=cid,
                    title=source.get("title", "Untitled"),
                    source=source.get("site", "Unknown"),
                    date=source.get("date", ""),
                    url=source.get("url", ""),
                    format_type="reference_with_url" if source.get("url") else "reference",
                )
                lines.append(formatted)

        return "\n".join(lines)

    # ... other helper methods
```

---

## Testing

```python
# tests/test_template_loader.py

import pytest
from reasoning.templates.loader import TemplateLoader, template_loader


class TestTemplateLoader:
    """Test template loading and formatting."""

    def test_get_template_default_lang(self):
        """Test getting template with default language."""
        template = template_loader.get_template("strict")

        assert "title" in template
        assert "structure" in template

    def test_get_template_specific_lang(self):
        """Test getting template for specific language."""
        template = template_loader.get_template("discovery", "en-US")

        assert "Key Findings" in template.get("structure", "")

    def test_get_structure(self):
        """Test getting structure template."""
        structure = template_loader.get_structure("monitor", "zh-TW")

        assert "時間軸" in structure

    def test_get_verdict_template(self):
        """Test getting verdict template."""
        verdict = template_loader.get_verdict_template(
            "strict", "verified", "zh-TW"
        )

        assert "已查證" in verdict

    def test_format_citation(self):
        """Test citation formatting."""
        citation = template_loader.format_citation(
            citation_id=1,
            title="Test Article",
            source="News Site",
            date="2024-01-01",
            format_type="reference",
        )

        assert "[1]" in citation
        assert "Test Article" in citation

    def test_confidence_description(self):
        """Test confidence level descriptions."""
        high = template_loader.get_confidence_description(0.9, "zh-TW")
        low = template_loader.get_confidence_description(0.4, "zh-TW")

        assert "高度" in high
        assert "低度" in low
```

---

## Benefits

- ✅ Templates editable without code changes
- ✅ Multi-language support (i18n ready)
- ✅ Consistent formatting across modes
- ✅ Version controlled templates
- ✅ Easy A/B testing of templates
- ✅ Clear separation of content and logic
