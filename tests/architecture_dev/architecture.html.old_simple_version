<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLWeb System Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .workflow-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .workflow-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .workflow-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            display: flex;
            height: calc(100vh - 250px);
            min-height: 600px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #ffffff;
        }

        #dag-canvas {
            width: 100%;
            height: 100%;
            min-width: 3200px;
            min-height: 1500px;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node-rect {
            fill: #ffffff;
            stroke: #667eea;
            stroke-width: 2;
            rx: 8;
            transition: all 0.3s ease;
        }

        .node:hover .node-rect {
            fill: #f0f4ff;
            stroke: #764ba2;
            stroke-width: 3;
        }

        .node.selected .node-rect {
            fill: #e8f0ff;
            stroke: #667eea;
            stroke-width: 4;
        }

        .node.same-level .node-rect {
            fill: #d4edda;
            stroke: #28a745;
            stroke-width: 3;
        }

        .node.child-level .node-rect {
            fill: #d1ecf1;
            stroke: #17a2b8;
            stroke-width: 3;
        }

        .node-text {
            fill: #333;
            font-size: 14px;
            font-weight: 600;
            pointer-events: none;
            user-select: none;
        }

        .node-script {
            fill: #555;
            font-size: 11px;
            pointer-events: none;
            user-select: none;
        }

        .toggle-btn {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-circle {
            fill: #667eea;
            stroke: #ffffff;
            stroke-width: 2;
        }

        .toggle-btn:hover .toggle-circle {
            fill: #764ba2;
        }

        .toggle-icon {
            fill: white;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
        }

        .edge {
            fill: none;
            stroke: #667eea;
            stroke-width: 2;
            marker-end: url(#arrowhead);
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .edge.feedback {
            stroke-dasharray: 5, 5;
            stroke: #dc3545;
        }

        .info-panel {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }

        .info-panel.visible {
            display: block;
        }

        .info-panel h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .info-panel p {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .info-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .info-panel .close-btn:hover {
            background: #c82333;
            transform: rotate(90deg);
        }

        .legend {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .legend h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .legend-box {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }

        .legend-box.selected {
            background: #e8f0ff;
            border-color: #667eea;
        }

        .legend-box.same-level {
            background: #d4edda;
            border-color: #28a745;
        }

        .legend-box.child-level {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .legend-item .feedback-line {
            width: 30px;
            height: 0;
            border-top: 2px dashed #dc3545;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è NLWeb System Architecture</h1>
            <p>Interactive DAG Visualization - Click nodes to explore relationships</p>
        </div>
        <div class="controls">
            <strong>Workflows:</strong>
            <button class="workflow-btn active" data-workflow="1">Workflow 1: Complete Flow</button>
            <button class="workflow-btn" data-workflow="2">Workflow 2: Retrieval Pipeline</button>
            <button class="workflow-btn" data-workflow="3">Workflow 3: Ranking Pipeline</button>
            <button class="workflow-btn" data-workflow="4">Workflow 4: System Components</button>
        </div>
        <div class="main-content">
            <div class="canvas-container">
                <svg id="dag-canvas">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#667eea" />
                        </marker>
                    </defs>
                    <g id="edges-group"></g>
                    <g id="nodes-group"></g>
                </svg>
                <div id="info-panel" class="info-panel">
                    <button class="close-btn" onclick="closeInfoPanel()">√ó</button>
                    <h3 id="info-title">Entity Name</h3>
                    <p id="info-content">Design rationale will appear here...</p>
                </div>
                <div class="legend">
                    <h4>Legend</h4>
                    <div class="legend-item">
                        <div class="legend-box selected"></div><span>Selected Node</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box same-level"></div><span>Same Level</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box child-level"></div><span>Child Level</span>
                    </div>
                    <div class="legend-item">
                        <div class="feedback-line"></div><span>Feedback Loop</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const graphData = {
            nodes: [
                { id: 'sys-fe', label: 'Frontend UI', level: -1, rationale: 'Áõ¥ËßÄÁöÑÊ±∫Á≠ñÊîØÊè¥ÂÑÄË°®ÊùøÔºåÂ∞áË§áÈõúÊï∏ÊìöËΩâÂåñÁÇ∫Ê∏ÖÊô∞Ê¥ûÂØüÔºåÊèê‰æõÊµÅÊö¢ÁöÑ‰∫íÂãïÈ´îÈ©ó„ÄÇ', script: 'static/index.html' },
                { id: 'sys-api', label: 'API Gateway', level: -1, rationale: '‰ºÅÊ•≠Á¥öÂÆâÂÖ®Á∂≤ÈóúÔºåÁ¢∫‰øùÈ´ò‰ΩµÁôº‰∏ãÁöÑÁ≥ªÁµ±Á©©ÂÆöÊÄßÔºåÊèê‰æõÁµ±‰∏ÄÁöÑÊúçÂãôÊé•ÂÖ•ËàáË≥áÂÆâÈò≤Ë≠∑„ÄÇ', script: 'webserver/routes/api.py' },
                { id: 'idx-1', label: 'Data Sources', level: 0, rationale: 'Êï¥ÂêàÂ§öÊ∫êÁï∞Ë≥™Êï∏ÊìöÔºàÊñ∞ËÅû„ÄÅÂ†±Âëä„ÄÅÊñáÊ™îÔºâÔºåÂª∫Á´ãÂÖ®Êñπ‰ΩçÁöÑÂ∏ÇÂ†¥ÊÉÖÂ†±Á∂≤Áµ°ÔºåÁ¢∫‰øùË≥áË®äÂª£Â∫¶„ÄÇ', script: 'External Sources' },
                { id: 'idx-2', label: 'Ingestion', level: 0, rationale: 'Ëá™ÂãïÂåñÊï∏ÊìöÊèêÁÖâÂ∑•Âª†ÔºåÈÄèÈÅé AI Ê∏ÖÊ¥óËàáÊ®ôÊ∫ñÂåñÔºåÂ∞áÂéüÂßãË≥áÊñôËΩâÂåñÁÇ∫È´òÂìÅË≥™ÁöÑÁü•Ë≠òË≥áÁî¢„ÄÇ', script: 'scraping/incrementalCrawlAndLoad.py' },
                { id: 'idx-3', label: 'Feature Extraction', level: 0, rationale: 'AI È©ÖÂãïÁöÑÁâπÂæµÂ∑•Á®ãÔºåËá™ÂãïÊèêÂèñÂºïÁî®„ÄÅÂØ¶È´îËàáÈóúÈçµÊï∏ÊìöÔºåÊ∑±Â∫¶ÊåñÊéòÊñáÊú¨ËÉåÂæåÁöÑÈö±Âê´ÂÉπÂÄº„ÄÇ', script: 'core/post_ranking.py' },
                { id: 'idx-4', label: 'Document Object', level: 0, rationale: 'Ê®ôÊ∫ñÂåñÁü•Ë≠òÂñÆÂÖÉÔºåÂ∞áÈùûÁµêÊßãÂåñË≥áË®äËΩâÁÇ∫Áµ±‰∏ÄÊ†ºÂºèÔºåÂØ¶ÁèæË∑®Âπ≥Âè∞ÁöÑÈ´òÊïàÊï∏ÊìöÊµÅÈÄöËàáÊáâÁî®„ÄÇ', script: 'core/schemas.py' },
                { id: 'sys-db', label: 'Postgres DB', level: 0, rationale: 'ÂèØÊì¥Â±ïÁöÑÊï∏ÊìöÂü∫Â∫ßÔºåÂÆåÊï¥Ë®òÈåÑÊâÄÊúâÂéüÂßãÊñáÁ´†„ÄÅÂÖÉÊï∏ÊìöËàáÁî®Êà∂Ê±∫Á≠ñÊ≠∑Á®ãÔºåÁ¢∫‰øùÊï∏ÊìöË≥áÁî¢ÂÆâÂÖ®„ÄÇ', script: 'retrieval_providers/postgres_client.py' },
                { id: 'ret-alg-1', label: 'BM25 Scorer', level: 0.5, rationale: 'Á∂ìÂÖ∏ÈóúÈçµÂ≠óÊ™¢Á¥¢ÊºîÁÆóÊ≥ïÔºåÊé°Áî® TF-IDF ÈÄ≤ÈöéÁâàÊú¨ (k‚ÇÅ=1.5, b=0.75)ÔºåÂπ≥Ë°°Ë©ûÈ†ªËàáÊñáÊ™îÈï∑Â∫¶„ÄÇ', script: 'core/bm25.py' },
                { id: 'ret-alg-2', label: 'Vector Encoder', level: 0.5, rationale: 'Ê∑±Â∫¶Ë™ûÊÑèÁ∑®Á¢ºÂô®ÔºåÂ∞áÊü•Ë©¢ËàáÊñáÊ™îËΩâÁÇ∫ 1536 Á∂≠ÂêëÈáèÁ©∫ÈñìÔºåÂØ¶ÁèæË∑®Ë™ûË®ÄÁöÑÊ¶ÇÂøµÁ¥öÁêÜËß£„ÄÇ', script: 'core/llm.py' },
                { id: 'ret-alg-3', label: 'Hybrid Fusion', level: 0.5, rationale: 'Â§ö‰ø°ËôüËûçÂêàÂºïÊìéÔºåÊô∫ÊÖßÊï¥ÂêàÂêëÈáèÁõ∏‰ººÂ∫¶„ÄÅÈóúÈçµÂ≠óÂåπÈÖçÔºåÊúÄÂ§ßÂåñÊ™¢Á¥¢Á≤æÊ∫ñÂ∫¶„ÄÇ', script: 'retrieval_providers/qdrant.py' },
                { id: 'ret-1', label: 'Hybrid Index', level: 1, rationale: 'Êñ∞‰∏Ä‰ª£Ê∑∑ÂêàÁ¥¢ÂºïÊäÄË°ìÔºåÁµêÂêàÂêëÈáèË™ûÊÑèËàáÈóúÈçµÂ≠óÂåπÈÖçÔºåÁ≤æÁ¢∫ÊçïÊçâÁ¥∞ÂæÆÁöÑË≥áË®äÈóúËÅØ„ÄÇ', script: 'core/retriever.py' },
                { id: 'ret-2', label: 'Retrieval API', level: 1, rationale: 'ÈùàÊ¥ªÁöÑÊï∏ÊìöË™øÁî®Êé•Âè£ÔºåÊîØÊåÅÊåâÈúÄÊ™¢Á¥¢ËàáÂãïÊÖãÈÅéÊøæÔºåÁÑ°Á∏´Â∞çÊé•ÂêÑÈ°û‰ºÅÊ•≠ÊáâÁî®Â†¥ÊôØ„ÄÇ', script: 'core/retriever.py' },
                { id: 'sys-vec', label: 'Qdrant Vector DB', level: 1, rationale: 'Ë™ûÊÑèÁêÜËß£Ê†∏ÂøÉÔºåÂ∞áÊñáÂ≠óËΩâÂåñÁÇ∫È´òÁ∂≠ÂêëÈáèÔºåÂØ¶ÁèæË∂ÖË∂äÈóúÈçµÂ≠óÁöÑÊ∑±Â∫¶Ê¶ÇÂøµÊêúÂ∞ãËàáÈóúËÅØÂàÜÊûê„ÄÇ', script: 'retrieval_providers/qdrant.py' },
                { id: 'sys-cache', label: 'In-Memory Cache', level: 1, rationale: 'Ê•µÈÄüÂõûÊáâÊ©üÂà∂ÔºåÈÄèÈÅéË®òÊÜ∂È´îÂø´ÂèñÁÜ±ÈñÄÊü•Ë©¢ËàáÁµêÊûúÔºåÂ§ßÂπÖÈôç‰ΩéÂª∂ÈÅ≤ÔºåÊèê‰æõÂç≥ÊôÇÈüøÊáâÈ´îÈ©ó„ÄÇ', script: 'chat/cache.py' },
                { id: 'rank-alg-1', label: 'LLM Ranker', level: 1.5, rationale: 'Ê∑±Â∫¶Ë™ûÊÑèÊéíÂ∫èÂºïÊìéÔºåÂà©Áî® GPT-4 ÈÄ≤Ë°åÂ§öÁ∂≠Â∫¶Áõ∏ÈóúÊÄßÂà§Êñ∑ÔºåËº∏Âá∫ 0-100 ÂàÜÊï∏ËàáËß£ÈáãÊÄßÊëòË¶Å„ÄÇ', script: 'core/ranking.py' },
                { id: 'rank-alg-2', label: 'MMR Diversifier', level: 1.5, rationale: 'Â§öÊ®£ÊÄßÂÑ™ÂåñÊºîÁÆóÊ≥ïÔºàŒª=0.7ÔºâÔºåÈÄèÈÅéÁõ∏‰ººÂ∫¶Êá≤ÁΩ∞Ê©üÂà∂ÈÅøÂÖçÁµêÊûúÂÜóÈ§òÔºåÊ†πÊìöÊÑèÂúñËá™ÈÅ©ÊáâË™øÊï¥„ÄÇ', script: 'core/mmr.py' },
                { id: 'rank-alg-3', label: 'XGBoost Predictor', level: 1.5, rationale: 'Ê©üÂô®Â≠∏ÁøíÊéíÂ∫èÊ®°ÂûãÔºåÂü∫Êñº 29 Á∂≠ÁâπÂæµÈÄ≤Ë°åÊô∫ÊÖßÈ†êÊ∏¨ÔºåÁõÆÂâç Shadow Mode Á¥ØÁ©çË®ìÁ∑¥Êï∏Êìö„ÄÇ', script: 'core/xgboost_ranker.py' },
                { id: 'rea-1', label: 'Query Analysis', level: 2, rationale: 'Âç≥ÊôÇ AI ÂàÜÊûêÔºåÂø´ÈÄüËß£ÊûêÁî®Êà∂ÊÑèÂúñÔºåÊßãÂª∫ÂàùÊ≠•Á≠îÊ°àÊ°ÜÊû∂‰∏¶ÈéñÂÆöÈóúÈçµÂïèÈ°åÊ†∏ÂøÉ„ÄÇ', script: 'chat/chatbot_interface.py' },
                { id: 'rea-2', label: 'Gap Detection', level: 2, rationale: 'Êô∫ÊÖßÁº∫Âè£ÂÅµÊ∏¨Ôºå‰∏ªÂãïÁôºÁèæË´ñË≠âÈÇèËºØ‰∏≠ÁöÑË≥áË®äÁõ≤ÈªûËàáË≠âÊìöÁº∫Â§±ÔºåÈ©ÖÂãïÊ∑±Â∫¶ÊåñÊéò„ÄÇ', script: 'core/query_analysis/required_info.py' },
                { id: 'rea-3', label: 'Iterative Search', level: 2, rationale: 'Ëá™ÈÅ©ÊáâÈñâÁí∞ÊêúÂ∞ãÂºïÊìéÔºåÈáùÂ∞çÁº∫Â§±Ë≥áË®äËá™ÂãïÁôºËµ∑ËøΩÂä†Ê™¢Á¥¢ÔºåËø≠‰ª£Áõ¥Ëá≥ÊâæÂà∞Á¢∫ÈëøË≠âÊìö„ÄÇ', script: 'chat/conversation.py' },
                { id: 'rea-4', label: 'Final Reasoning', level: 2, rationale: 'ÂèØËß£ÈáãÊÄß AI Êé®Ë´ñÔºåÁ∂úÂêàÂ§öÊñπË≠âÊìöÁî¢Âá∫ÈÇèËºØÂö¥ÂØÜ„ÄÅÈôÑÂ∏∂ÊÜëÊìöÁöÑÂ∞àÊ•≠Ê±∫Á≠ñÂª∫Ë≠∞„ÄÇ', script: 'chat/conversation.py' },
                { id: 'sys-llm', label: 'GPT-4 Service', level: 2.5, rationale: 'OpenAI GPT-4 Ê®°ÂûãÊúçÂãôÔºåÊèê‰æõÂº∑Â§ßÁöÑËá™ÁÑ∂Ë™ûË®ÄÁêÜËß£„ÄÅÂàÜÊûêËàáÁîüÊàêËÉΩÂäõÔºåÈ©ÖÂãïÊô∫ÊÖßÊéíÂ∫èËàáÊé®Ë´ñ„ÄÇ', script: 'core/llm.py' },
                { id: 'sys-ana', label: 'Analytics', level: 2.5, rationale: 'ÂÖ®ÈèàË∑ØÊï∏ÊìöÂàÜÊûêÔºåÂç≥ÊôÇËøΩËπ§Êé®Ë´ñÊ≠•È©üËàáÁî®Êà∂ÂèçÈ•ãÔºåÊåÅÁ∫åÂÑ™ÂåñÊ®°ÂûãË°®ÁèæËàáÁ≥ªÁµ±ÊïàËÉΩ„ÄÇ', script: 'webserver/ranking_analytics_handler.py' }
            ],
            edges: {
                workflow1: [{ from: 'idx-1', to: 'idx-2' }, { from: 'idx-2', to: 'idx-3' }, { from: 'idx-3', to: 'idx-4' }, { from: 'idx-4', to: 'ret-1' }, { from: 'ret-1', to: 'ret-2' }, { from: 'ret-2', to: 'rank-alg-1' }, { from: 'rank-alg-1', to: 'rea-1' }, { from: 'rea-1', to: 'rea-2' }, { from: 'rea-2', to: 'rea-3' }, { from: 'rea-3', to: 'ret-2', type: 'feedback' }, { from: 'rea-3', to: 'rea-4' }],
                workflow2: [{ from: 'ret-alg-1', to: 'ret-alg-3' }, { from: 'ret-alg-2', to: 'ret-alg-3' }, { from: 'ret-alg-3', to: 'ret-1' }, { from: 'sys-vec', to: 'ret-1' }, { from: 'ret-1', to: 'ret-2' }, { from: 'ret-2', to: 'sys-cache' }],
                workflow3: [{ from: 'ret-2', to: 'rank-alg-1' }, { from: 'sys-llm', to: 'rank-alg-1' }, { from: 'rank-alg-1', to: 'rank-alg-2' }, { from: 'rank-alg-2', to: 'rank-alg-3' }, { from: 'rank-alg-3', to: 'rea-1' }],
                workflow4: [{ from: 'sys-fe', to: 'sys-api' }, { from: 'sys-api', to: 'rea-1' }, { from: 'idx-1', to: 'idx-2' }, { from: 'idx-2', to: 'sys-db' }, { from: 'sys-db', to: 'idx-3' }, { from: 'idx-3', to: 'idx-4' }, { from: 'idx-4', to: 'sys-vec' }, { from: 'sys-vec', to: 'ret-1' }, { from: 'ret-2', to: 'sys-cache' }, { from: 'rea-1', to: 'sys-llm' }, { from: 'rea-3', to: 'ret-2', type: 'feedback' }, { from: 'rea-4', to: 'sys-ana' }]
            }
        };

        let currentWorkflow = 'workflow1', selectedNode = null;
        const config = { nodeWidth: 180, nodeHeight: 80, levelGap: 500, nodeGap: 100, marginX: 100, marginY: 150 };

        function calculateLayout() {
            const levels = {};
            let minLevel = 0;
            graphData.nodes.forEach(n => { if (n.level < minLevel) minLevel = n.level; });
            graphData.nodes.forEach(n => { if (!levels[n.level]) levels[n.level] = []; levels[n.level].push(n); });
            graphData.nodes.forEach(n => {
                const levelNodes = levels[n.level], idx = levelNodes.indexOf(n);
                const totalH = levelNodes.length * config.nodeHeight + (levelNodes.length - 1) * config.nodeGap;
                n.x = config.marginX + (n.level - minLevel) * config.levelGap;
                n.y = config.marginY + (idx * (config.nodeHeight + config.nodeGap)) + (1500 - totalH) / 2;
            });
        }

        function positionLegend() {
            const maxX = Math.max(...graphData.nodes.map(n => n.x + config.nodeWidth));
            const legend = document.querySelector('.legend');
            legend.style.left = (maxX + 50) + 'px';
            legend.style.top = '20px';
        }

        function drawGraph() { calculateLayout(); positionLegend(); drawEdges(); drawNodes(); }

        function drawEdges() {
            const eg = document.getElementById('edges-group');
            eg.innerHTML = '';
            (graphData.edges[currentWorkflow] || []).forEach(e => {
                const from = graphData.nodes.find(n => n.id === e.from), to = graphData.nodes.find(n => n.id === e.to);
                if (!from || !to) return;
                const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let d;
                if (e.type === 'feedback') {
                    const x1 = from.x + config.nodeWidth / 2, y1 = from.y, x2 = to.x + config.nodeWidth / 2, y2 = to.y;
                    const cpY = Math.min(y1, y2) - 150;
                    d = `M ${x1} ${y1} C ${x1} ${cpY}, ${x2} ${cpY}, ${x2} ${y2}`;
                } else {
                    const x1 = from.x + config.nodeWidth, y1 = from.y + config.nodeHeight / 2;
                    const x2 = to.x, y2 = to.y + config.nodeHeight / 2, midX = (x1 + x2) / 2;
                    d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                }
                p.setAttribute('d', d);
                p.setAttribute('class', e.type === 'feedback' ? 'edge feedback' : 'edge');
                eg.appendChild(p);
            });
        }

        function drawNodes() {
            const ng = document.getElementById('nodes-group');
            ng.innerHTML = '';
            graphData.nodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'node');
                g.setAttribute('data-id', node.id);
                const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                r.setAttribute('class', 'node-rect');
                r.setAttribute('x', node.x); r.setAttribute('y', node.y);
                r.setAttribute('width', config.nodeWidth); r.setAttribute('height', config.nodeHeight);
                g.appendChild(r);
                const l = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                l.setAttribute('class', 'node-text');
                l.setAttribute('x', node.x + config.nodeWidth / 2);
                l.setAttribute('y', node.y + config.nodeHeight / 2 - 5);
                l.setAttribute('text-anchor', 'middle');
                l.textContent = node.label;
                g.appendChild(l);
                if (node.script) {
                    const s = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    s.setAttribute('class', 'node-script');
                    s.setAttribute('x', node.x + config.nodeWidth / 2);
                    s.setAttribute('y', node.y + config.nodeHeight / 2 + 15);
                    s.setAttribute('text-anchor', 'middle');
                    s.textContent = node.script;
                    g.appendChild(s);
                }
                const tb = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                tb.setAttribute('class', 'toggle-btn');
                const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                c.setAttribute('class', 'toggle-circle');
                c.setAttribute('cx', node.x + config.nodeWidth - 15);
                c.setAttribute('cy', node.y + 15);
                c.setAttribute('r', 12);
                tb.appendChild(c);
                const i = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                i.setAttribute('class', 'toggle-icon');
                i.setAttribute('x', node.x + config.nodeWidth - 15);
                i.setAttribute('y', node.y + 20);
                i.setAttribute('text-anchor', 'middle');
                i.textContent = 'i';
                tb.appendChild(i);
                tb.addEventListener('click', e => { e.stopPropagation(); showInfoPanel(node); });
                g.appendChild(tb);
                g.addEventListener('click', () => selectNode(node));
                ng.appendChild(g);
            });
        }

        function selectNode(node) {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected', 'same-level', 'child-level'));
            selectedNode = node;
            document.querySelector(`.node[data-id="${node.id}"]`).classList.add('selected');
            graphData.nodes.forEach(n => {
                if (n.level === node.level && n.id !== node.id) document.querySelector(`.node[data-id="${n.id}"]`).classList.add('same-level');
            });
            const children = (graphData.edges[currentWorkflow] || []).filter(e => e.from === node.id).map(e => e.to);
            children.forEach(cid => { const el = document.querySelector(`.node[data-id="${cid}"]`); if (el) el.classList.add('child-level'); });
        }

        function showInfoPanel(node) {
            const panel = document.getElementById('info-panel');
            document.getElementById('info-title').textContent = node.label;
            document.getElementById('info-content').textContent = node.rationale;
            panel.style.left = (node.x + config.nodeWidth + 20) + 'px';
            panel.style.top = node.y + 'px';
            panel.classList.add('visible');
        }

        function closeInfoPanel() { document.getElementById('info-panel').classList.remove('visible'); }

        function switchWorkflow(wid) {
            currentWorkflow = 'workflow' + wid;
            document.querySelectorAll('.workflow-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.workflow === wid) btn.classList.add('active');
            });
            drawGraph();
        }

        document.addEventListener('DOMContentLoaded', () => {
            drawGraph();
            document.querySelectorAll('.workflow-btn').forEach(btn => btn.addEventListener('click', () => switchWorkflow(btn.dataset.workflow)));
            document.addEventListener('click', e => { if (!e.target.closest('.info-panel') && !e.target.closest('.toggle-btn')) closeInfoPanel(); });
        });
    </script>
</body>

</html>